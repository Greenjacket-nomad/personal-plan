<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Reports - Curriculum Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --bg-primary: #f5f5f4;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e7e5e4;
            --text-primary: #1c1917;
            --text-secondary: #44403c;
            --text-muted: #78716c;
            --border: rgba(0, 0, 0, 0.15);
            --accent: #0066ff;
            --accent-hover: #0052cc;
            --success: #16a34a;
            --warning: #ca8a04;
            --error: #dc2626;
            --phase-1: #2563eb;
            --phase-2: #7c3aed;
            --phase-3: #0d9488;
            --phase-4: #ea580c;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #171717;
            --bg-tertiary: #262626;
            --text-primary: #fafafa;
            --text-secondary: #d4d4d4;
            --text-muted: #a3a3a3;
            --border: rgba(255, 255, 255, 0.15);
            --accent: #00d4ff;
            --accent-hover: #00b8e6;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
            --phase-1: #3b82f6;
            --phase-2: #8b5cf6;
            --phase-3: #14b8a6;
            --phase-4: #f97316;
        }
        
        * {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent);
        }
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-accent { color: var(--accent); }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        
        /* Navigation Styles */
        .nav-item {
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 150ms ease;
            display: inline-flex;
            align-items: center;
            text-decoration: none;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }
        
        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent);
            font-weight: 600;
        }
        
        .header a.text-2xl:hover {
            transform: scale(1.05);
            transition: transform 150ms ease;
        }
        
        #breadcrumbs {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        #breadcrumbs a {
            color: var(--text-secondary);
            transition: color 150ms ease;
        }
        
        #breadcrumbs a:hover {
            color: var(--accent);
        }
        
        #mobile-menu {
            border-top: 1px solid var(--border);
            margin-top: 1rem;
            padding-top: 1rem;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 150ms ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .theme-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 150ms ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
    </style>
    <script>
        // Load theme before page renders to prevent flash
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="min-h-screen">
    <header class="header py-6 px-8">
        <div class="max-w-7xl mx-auto">
            <!-- Unified Navigation -->
            <div class="flex items-center justify-between">
                <!-- Left: Logo + Breadcrumbs -->
                <div class="flex items-center gap-6">
                    <a href="/" class="text-2xl font-bold text-primary hover:text-accent transition-all" title="Dashboard">
                        <i class="fas fa-graduation-cap mr-2"></i>
                        <span class="hidden md:inline">Curriculum Tracker</span>
                    </a>
                    {% if request.path != '/' %}
                    <button onclick="goBack()" class="btn-secondary px-3 py-2 text-sm">
                        <i class="fas fa-arrow-left mr-1"></i>
                        <span class="hidden md:inline">Back</span>
                    </button>
                    {% endif %}
                    <div id="breadcrumbs" class="text-sm text-secondary hidden md:flex items-center gap-2">
                        <!-- Dynamic breadcrumbs inserted here -->
                    </div>
                </div>
                
                <!-- Right: Navigation + Utilities -->
                <div class="flex items-center gap-6">
                    <!-- Main Navigation -->
                    <nav class="hidden md:flex items-center gap-4">
                        <a href="/" class="nav-item {% if request.path == '/' or request.path.startswith('/view/') %}active{% endif %}">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/resources" class="nav-item {% if '/resources' in request.path or '/curriculum' in request.path %}active{% endif %}">
                            <i class="fas fa-book mr-1"></i>Curriculum
                        </a>
                        <a href="/journal" class="nav-item {% if '/journal' in request.path %}active{% endif %}">
                            <i class="fas fa-book-open mr-1"></i>Journal
                        </a>
                        <a href="/calendar" class="nav-item {% if '/calendar' in request.path %}active{% endif %}">
                            <i class="fas fa-calendar mr-1"></i>Calendar
                        </a>
                        <a href="/reports" class="nav-item {% if '/reports' in request.path %}active{% endif %}">
                            <i class="fas fa-chart-bar mr-1"></i>Reports
                        </a>
                        <a href="/activity" class="nav-item {% if '/activity' in request.path %}active{% endif %}">
                            <i class="fas fa-history mr-1"></i>Activity
                        </a>
                    </nav>
                    
                    <!-- Utilities -->
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="theme-toggle" title="Toggle dark mode">
                            <span class="theme-icon"></span>
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Toggle -->
                    <button onclick="toggleMobileMenu()" class="md:hidden text-primary">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu (hidden by default) -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4">
                <nav class="flex flex-col gap-3">
                    <a href="/" class="nav-item {% if request.path == '/' or request.path.startswith('/view/') %}active{% endif %}"><i class="fas fa-home mr-2"></i>Dashboard</a>
                    <a href="/resources" class="nav-item {% if '/resources' in request.path or '/curriculum' in request.path %}active{% endif %}"><i class="fas fa-book mr-2"></i>Curriculum</a>
                    <a href="/journal" class="nav-item {% if '/journal' in request.path %}active{% endif %}"><i class="fas fa-book-open mr-2"></i>Journal</a>
                    <a href="/calendar" class="nav-item {% if '/calendar' in request.path %}active{% endif %}"><i class="fas fa-calendar mr-2"></i>Calendar</a>
                    <a href="/reports" class="nav-item {% if '/reports' in request.path %}active{% endif %}"><i class="fas fa-chart-bar mr-2"></i>Reports</a>
                    <a href="/activity" class="nav-item {% if '/activity' in request.path %}active{% endif %}"><i class="fas fa-history mr-2"></i>Activity</a>
                </nav>
            </div>
        </div>
    </header>
    
    <div class="max-w-7xl mx-auto p-6">
        <!-- Hours by Phase -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold text-primary mb-4">Hours by Phase</h2>
            <div style="height: 250px; max-height: 250px;">
                <canvas id="phase-chart"></canvas>
            </div>
        </div>
        
        <!-- Hours by Resource Type -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold text-primary mb-4">Hours by Resource Type</h2>
            <div style="height: 250px; max-height: 250px;">
                <canvas id="type-chart"></canvas>
            </div>
        </div>
        
        <!-- Hours by Week -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold text-primary mb-4">Hours by Week</h2>
            <div style="height: 250px; max-height: 250px;">
                <canvas id="week-chart"></canvas>
            </div>
        </div>
        
        <!-- Daily Average -->
        <div class="card">
            <h2 class="text-xl font-bold text-primary mb-4">Daily Average</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-secondary mb-1">Current Daily Average</p>
                    <p class="text-2xl font-bold text-primary">{{ "%.2f"|format(reports.daily_avg) }}h</p>
                </div>
                <div>
                    <p class="text-sm text-secondary mb-1">Needed Daily Average</p>
                    <p class="text-2xl font-bold {% if reports.needed_daily > reports.daily_avg %}text-error{% else %}text-success{% endif %}">
                        {{ "%.2f"|format(reports.needed_daily) }}h
                    </p>
                </div>
            </div>
            <p class="text-sm text-secondary mt-4">Total hours logged: <span class="font-semibold text-primary">{{ "%.1f"|format(reports.total_hours) }}h</span></p>
        </div>
    </div>
    
    <script>
        const reportsData = {{ reports|tojson }};
        
        // Store chart instances for theme updates
        let phaseChart = null;
        let typeChart = null;
        let weekChart = null;
        
        function getComputedColor(cssVar) {
            return getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
        }
        
        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || localStorage.getItem('theme') || 'dark';
        }
        
        function getChartColors() {
            const theme = getCurrentTheme();
            return {
                textColor: theme === 'dark' ? '#e5e7eb' : '#1f2937',
                gridColor: theme === 'dark' ? '#374151' : '#e5e7eb',
                backgroundColor: theme === 'dark' ? '#1f2937' : '#ffffff',
                borderColor: theme === 'dark' ? '#4b5563' : '#d1d5db'
            };
        }
        
        function updateChartColors() {
            // Destroy existing charts
            if (phaseChart) phaseChart.destroy();
            if (typeChart) typeChart.destroy();
            if (weekChart) weekChart.destroy();
            
            // Recreate charts with new colors
            createCharts();
        }
        
        function createCharts() {
            const colors = getChartColors();
            // Hours by Phase
            const phaseCtx = document.getElementById('phase-chart');
            if (phaseCtx && reportsData.by_phase) {
                phaseChart = new Chart(phaseCtx, {
                type: 'bar',
                data: {
                    labels: reportsData.by_phase.map(p => `Phase ${p.phase_index + 1}`),
                    datasets: [{
                        label: 'Hours Logged',
                        data: reportsData.by_phase.map(p => p.hours || 0),
                        backgroundColor: [
                            'var(--phase-1)',
                            'var(--phase-2)',
                            'var(--phase-3)',
                            'var(--phase-4)'
                        ]
                    }, {
                        label: 'Target (96h)',
                        data: reportsData.by_phase.map(() => 96),
                        type: 'line',
                        borderColor: 'var(--accent)',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor },
                            title: {
                                display: true,
                                text: 'Hours',
                                color: colors.textColor
                            }
                        }
                    }
                }
                });
            }
            
            // Hours by Type
            const typeCtx = document.getElementById('type-chart');
            if (typeCtx && reportsData.by_type) {
                typeChart = new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: reportsData.by_type.map(t => t.resource_type || 'Unknown'),
                    datasets: [{
                        data: reportsData.by_type.map(t => t.hours || 0),
                        backgroundColor: [
                            'var(--accent)',
                            'var(--success)',
                            'var(--warning)',
                            'var(--phase-1)',
                            'var(--phase-2)',
                            'var(--phase-3)',
                            'var(--phase-4)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor
                            }
                        }
                    }
                }
            });
        }
        
            // Hours by Week
            const weekCtx = document.getElementById('week-chart');
            if (weekCtx && reportsData.by_week) {
                weekChart = new Chart(weekCtx, {
                type: 'line',
                data: {
                    labels: reportsData.by_week.map(w => `Week ${w.week}`),
                    datasets: [{
                        label: 'Hours Logged',
                        data: reportsData.by_week.map(w => w.hours || 0),
                        borderColor: 'var(--accent)',
                        backgroundColor: 'rgba(0, 102, 255, 0.1)',
                        fill: true
                    }, {
                        label: 'Target (24h/week)',
                        data: reportsData.by_week.map(() => 24),
                        type: 'line',
                        borderColor: 'var(--success)',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor },
                            title: {
                                display: true,
                                text: 'Hours',
                                color: colors.textColor
                            }
                        }
                    }
                }
                });
            }
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon();
            updateChartColors();
        }
        
        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }
        }
        
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
        
        // Back button function
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }
        
        // Generate breadcrumbs dynamically
        function generateBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!breadcrumbs) return;
            
            const path = window.location.pathname;
            const parts = path.split('/').filter(Boolean);
            
            if (parts.length === 0) {
                breadcrumbs.innerHTML = '<span>Dashboard</span>';
                return;
            }
            
            let html = '<a href="/" class="hover:text-accent">Dashboard</a>';
            
            const routeNames = {
                'resources': 'Curriculum',
                'curriculum': 'Curriculum',
                'journal': 'Journal',
                'calendar': 'Calendar',
                'reports': 'Reports',
                'activity': 'Activity',
                'view': 'Week View',
                'edit': 'Edit'
            };
            
            let currentPath = '';
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                
                if (part === 'calendar' && parts.length > index + 1) {
                    const year = parts[index + 1];
                    const month = parts[index + 2];
                    if (month) {
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = monthNames[parseInt(month) - 1] || month;
                        html += ` <i class="fas fa-chevron-right text-xs"></i> <span>${monthName} ${year}</span>`;
                        return;
                    }
                }
                
                if (part === 'view' && parts.length > index + 1) {
                    const phaseIndex = parseInt(parts[index + 1]);
                    const week = parts[index + 2];
                    if (week) {
                        html += ` <i class="fas fa-chevron-right text-xs"></i> <span>Phase ${phaseIndex + 1} > Week ${week}</span>`;
                        return;
                    }
                }
                
                if (index > 0 && parts[index - 1] === 'calendar' && (part.match(/^\d+$/) || index === 1)) {
                    return;
                }
                if (index > 0 && parts[index - 1] === 'view' && part.match(/^\d+$/)) {
                    return;
                }
                
                const name = routeNames[part] || part.charAt(0).toUpperCase() + part.slice(1);
                
                if (index === parts.length - 1) {
                    html += ` <i class="fas fa-chevron-right text-xs"></i> <span>${name}</span>`;
                } else {
                    html += ` <i class="fas fa-chevron-right text-xs"></i> <a href="${currentPath}" class="hover:text-accent">${name}</a>`;
                }
            });
            
            breadcrumbs.innerHTML = html;
        }
        
        // Initialize charts and theme icon
        document.addEventListener('DOMContentLoaded', function() {
            createCharts();
            updateThemeIcon();
            generateBreadcrumbs();
        });
    </script>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Toast Notification Script -->
    <script>
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${iconMap[type] || iconMap.info}"></i>
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }
        
        function removeToast(toast) {
            if (!toast) return;
            toast.classList.add('removing');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }
    </script>
</body>
</html>

