<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Activity History - Curriculum Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/design-system.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --bg-primary: #f5f5f4;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e7e5e4;
            --text-primary: #1c1917;
            --text-secondary: #44403c;
            --text-muted: #6b6560; /* Improved contrast: 4.6:1 on bg-primary, 5.2:1 on bg-secondary (meets WCAG AA) */
            --border: rgba(0, 0, 0, 0.15);
            --accent: #0066ff;
            --accent-hover: #0052cc;
            --success: #16a34a;
            --warning: #ca8a04;
            --error: #dc2626;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #171717;
            --bg-tertiary: #262626;
            --text-primary: #fafafa;
            --text-secondary: #d4d4d4;
            --text-muted: #a3a3a3;
            --border: rgba(255, 255, 255, 0.15);
            --accent: #00d4ff;
            --accent-hover: #00b8e6;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
        }
        
        * {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1, h2, h3, h4, h5, h6 {
            letter-spacing: -0.02em;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] .glass {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 150ms ease;
        }
        
        [data-theme="dark"] .card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            border-color: var(--accent);
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent);
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .header {
            background: linear-gradient(135deg, rgba(15, 15, 15, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
        }
        
        a {
            transition: color 150ms ease;
        }
        
        a:hover {
            color: var(--accent);
        }
        
        /* Utility Classes */
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-accent { color: var(--accent); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-error { color: var(--error); }
        
        .activity-complete { border-left: 4px solid var(--success); }
        .activity-hours { border-left: 4px solid var(--accent); }
        .activity-reset { border-left: 4px solid var(--error); }
        .activity-default { border-left: 4px solid var(--accent); }
        
        .empty-state { color: var(--text-secondary); }
        .empty-state-icon { color: var(--text-muted); opacity: 0.2; }
        
        /* Activity Timeline - Vertical Timeline with Alternating Cards */
        .activity-timeline {
            position: relative;
            padding-left: var(--spacing-2xl);
            padding-top: var(--spacing-lg);
        }
        
        /* Vertical line */
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: calc(var(--spacing-xl) + 6px);
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent), var(--border));
            z-index: 0;
        }
        
        .activity-timeline-group {
            position: relative;
            margin-bottom: var(--spacing-2xl);
        }
        
        .activity-group-header {
            font-size: var(--text-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
            margin-bottom: var(--spacing-lg);
            padding-left: var(--spacing-xl);
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .activity-group-header::before {
            content: '';
            position: absolute;
            left: calc(var(--spacing-xl) - 6px);
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg-primary);
            z-index: 2;
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        .activity-group-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .activity-group-count {
            background: var(--accent-light);
            color: var(--accent);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-weight-semibold);
        }
        
        .activity-item {
            position: relative;
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-fast) var(--ease-out);
            cursor: pointer;
            z-index: 1;
        }
        
        /* Timeline node on each item */
        .activity-item::before {
            content: '';
            position: absolute;
            left: calc(-1 * var(--spacing-2xl) + var(--spacing-xl) - 4px);
            top: var(--spacing-md);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            z-index: 2;
        }
        
        /* Alternating layout on desktop */
        @media (min-width: 768px) {
            .timeline-item-left {
                margin-right: 50%;
                padding-right: var(--spacing-lg);
            }
            
            .timeline-item-right {
                margin-left: 50%;
                padding-left: var(--spacing-lg);
            }
            
            .timeline-item-left::before {
                left: calc(50% - 4px);
            }
            
            .timeline-item-right::before {
                left: calc(-1 * var(--spacing-2xl) + var(--spacing-xl) - 4px);
            }
        }
        
        .activity-item:hover {
            transform: translateY(-2px);
        }
        
        .activity-item-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            transition: all var(--transition-fast) var(--ease-out);
            box-shadow: var(--shadow-sm);
        }
        
        .activity-item:hover .activity-item-card {
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
        }
        
        .activity-item.user-action .activity-item-card {
            background: var(--accent-light);
            border-left: 4px solid var(--accent);
        }
        
        .activity-item.system-event {
            background: rgba(107, 101, 96, 0.05);
            border-left-color: var(--text-muted);
            opacity: 0.8;
        }
        
        [data-theme="dark"] .activity-item.user-action {
            background: rgba(0, 212, 255, 0.1);
        }
        
        [data-theme="dark"] .activity-item.system-event {
            background: rgba(163, 163, 163, 0.1);
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 150ms ease;
        }
        
        .filter-chip:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .filter-chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .filter-chip .count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        
        /* Navigation Styles */
        .nav-item {
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 150ms ease;
            display: inline-flex;
            align-items: center;
            text-decoration: none;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }
        
        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent);
            font-weight: 600;
        }
        
        .header a.text-2xl:hover {
            transform: scale(1.05);
            transition: transform 150ms ease;
        }
        
        #breadcrumbs {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        #breadcrumbs a {
            color: var(--text-secondary);
            transition: color 150ms ease;
        }
        
        #breadcrumbs a:hover {
            color: var(--accent);
        }
        
        #mobile-menu {
            border-top: 1px solid var(--border);
            margin-top: 1rem;
            padding-top: 1rem;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 150ms ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .theme-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 150ms ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
    </style>
    <script>
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon();
        }
        
        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }
        }
    </script>
    <script src="/static/js/accessibility.js"></script>
</head>
    <body class="min-h-screen">
    <a href="#main-content" id="skip-to-main" class="skip-to-main">Skip to main content</a>
    
    <!-- Sidebar Navigation (Desktop) -->
    {% set current_page = 'activity' %}
    {% set user_name = current_user.username if current_user else 'User' %}
    {% include 'components/_sidebar_nav.html' %}
    
    <!-- Mobile Tab Bar (Mobile) -->
    {% set current_page = 'activity' %}
    {% include 'components/_mobile_tabbar.html' %}
    
    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper">
    <header class="header py-6 px-8">
        <div class="max-w-7xl mx-auto">
            <!-- Unified Navigation -->
            <div class="flex items-center justify-between">
                <!-- Left: Logo + Breadcrumbs -->
                <div class="flex items-center gap-6">
                    <a href="/" class="text-2xl font-bold text-primary hover:text-accent transition-all" title="Dashboard">
                        <i class="fas fa-graduation-cap mr-2"></i>
                        <span class="hidden md:inline">Curriculum Tracker</span>
                    </a>
                    {% if request.path != '/' %}
                    <button onclick="goBack()" class="btn-secondary px-3 py-2 text-sm">
                        <i class="fas fa-arrow-left mr-1"></i>
                        <span class="hidden md:inline">Back</span>
                    </button>
                    {% endif %}
                    <div id="breadcrumbs" class="text-sm text-secondary hidden md:flex items-center gap-2">
                        <!-- Dynamic breadcrumbs inserted here -->
                    </div>
                </div>
                
                <!-- Right: Navigation + Utilities -->
                <div class="flex items-center gap-6">
                    <!-- Main Navigation -->
                    <nav class="hidden md:flex items-center gap-4">
                        <a href="/" class="nav-item {% if request.path == '/' or request.path.startswith('/view/') %}active{% endif %}">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/resources" class="nav-item {% if '/resources' in request.path or '/curriculum' in request.path %}active{% endif %}">
                            <i class="fas fa-book mr-1"></i>Curriculum
                        </a>
                        <a href="/journal" class="nav-item {% if '/journal' in request.path %}active{% endif %}">
                            <i class="fas fa-book-open mr-1"></i>Journal
                        </a>
                        <a href="/calendar" class="nav-item {% if '/calendar' in request.path %}active{% endif %}">
                            <i class="fas fa-calendar mr-1"></i>Calendar
                        </a>
                        <a href="/reports" class="nav-item {% if '/reports' in request.path %}active{% endif %}">
                            <i class="fas fa-chart-bar mr-1"></i>Reports
                        </a>
                        <a href="/activity" class="nav-item {% if '/activity' in request.path %}active{% endif %}">
                            <i class="fas fa-history mr-1"></i>Activity
                        </a>
                    </nav>
                    
                    <!-- Utilities -->
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="theme-toggle" title="Toggle dark mode">
                            <span class="theme-icon"></span>
                        </button>
                    </div>
                    
                    <!-- Mobile Menu Toggle -->
                    <button onclick="toggleMobileMenu()" class="md:hidden text-primary">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu (hidden by default) -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4">
                <nav class="flex flex-col gap-3">
                    <a href="/" class="nav-item {% if request.path == '/' or request.path.startswith('/view/') %}active{% endif %}"><i class="fas fa-home mr-2"></i>Dashboard</a>
                    <a href="/resources" class="nav-item {% if '/resources' in request.path or '/curriculum' in request.path %}active{% endif %}"><i class="fas fa-book mr-2"></i>Curriculum</a>
                    <a href="/journal" class="nav-item {% if '/journal' in request.path %}active{% endif %}"><i class="fas fa-book-open mr-2"></i>Journal</a>
                    <a href="/calendar" class="nav-item {% if '/calendar' in request.path %}active{% endif %}"><i class="fas fa-calendar mr-2"></i>Calendar</a>
                    <a href="/reports" class="nav-item {% if '/reports' in request.path %}active{% endif %}"><i class="fas fa-chart-bar mr-2"></i>Reports</a>
                    <a href="/activity" class="nav-item {% if '/activity' in request.path %}active{% endif %}"><i class="fas fa-history mr-2"></i>Activity</a>
                </nav>
            </div>
        </div>
    </header>

    <main id="main-content" class="max-w-5xl mx-auto p-6">
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="font-bold text-primary"><i class="fas fa-history mr-2"></i>Recent Activity</h2>
            </div>
            
            {% if logs %}
            <!-- Activity Statistics Summary -->
            <div class="activity-stats">
                {% set complete_count = logs|selectattr('action', 'search', 'complete')|list|length %}
                {% set hours_count = logs|selectattr('action', 'search', 'hours')|list|length %}
                {% set metric_count = logs|selectattr('action', 'search', 'metric')|list|length %}
                <div class="activity-stat-pill" onclick="filterActivity('complete')">
                    <i class="fas fa-check-circle"></i>
                    <span class="activity-stat-label">Completed</span>
                    <span class="activity-stat-value">{{ complete_count }}</span>
                </div>
                <div class="activity-stat-pill" onclick="filterActivity('hours')">
                    <i class="fas fa-clock"></i>
                    <span class="activity-stat-label">Time Logged</span>
                    <span class="activity-stat-value">{{ hours_count }}</span>
                </div>
                <div class="activity-stat-pill" onclick="filterActivity('metric')">
                    <i class="fas fa-trophy"></i>
                    <span class="activity-stat-label">Metrics</span>
                    <span class="activity-stat-value">{{ metric_count }}</span>
                </div>
                <div class="activity-stat-pill active" onclick="filterActivity('all')">
                    <i class="fas fa-list"></i>
                    <span class="activity-stat-label">Total</span>
                    <span class="activity-stat-value">{{ logs|length }}</span>
                </div>
            </div>
            
            <!-- Filter Chips -->
            <div class="filter-chips" id="activity-filters">
                {% set complete_count = logs|selectattr('action', 'search', 'complete')|list|length %}
                {% set hours_count = logs|selectattr('action', 'search', 'hours')|list|length %}
                {% set metric_count = logs|selectattr('action', 'search', 'metric')|list|length %}
                <button class="filter-chip active" data-filter="all" onclick="filterActivity('all')">
                    <span>All</span>
                    <span class="count">{{ logs|length }}</span>
                </button>
                <button class="filter-chip" data-filter="complete" onclick="filterActivity('complete')">
                    <i class="fas fa-check-circle"></i>
                    <span>Completions</span>
                    <span class="count">{{ complete_count }}</span>
                </button>
                <button class="filter-chip" data-filter="hours" onclick="filterActivity('hours')">
                    <i class="fas fa-clock"></i>
                    <span>Time Logged</span>
                    <span class="count">{{ hours_count }}</span>
                </button>
                <button class="filter-chip" data-filter="metric" onclick="filterActivity('metric')">
                    <i class="fas fa-trophy"></i>
                    <span>Metrics</span>
                    <span class="count">{{ metric_count }}</span>
                </button>
            </div>
            
            <div class="activity-timeline" id="activity-timeline">
                <!-- Groups will be inserted here by JavaScript -->
            </div>
            {% else %}
            <div class="text-center py-12 empty-state">
                <i class="fas fa-history text-6xl mb-4 empty-state-icon"></i>
                <h3 class="text-lg font-semibold text-primary mb-2">Your journey begins here!</h3>
                <p class="text-secondary mb-4">Start tracking your progress and your activity will appear here.</p>
                <a href="/" class="btn-primary inline-flex items-center">
                    <i class="fas fa-arrow-right mr-2"></i>Go to Dashboard
                </a>
            </div>
            {% endif %}
        </div>
    </main>
    
    <script>
        // Pass logs data to JavaScript
        window.activityLogs = {{ logs|tojson if logs else '[]' }};
    </script>
    <script src="/static/js/activity.js"></script>
    
    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
        
        // Back button function
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }
        
        // Generate breadcrumbs dynamically
        function generateBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!breadcrumbs) return;
            
            const path = window.location.pathname;
            const parts = path.split('/').filter(Boolean);
            
            if (parts.length === 0) {
                breadcrumbs.innerHTML = '<span>Dashboard</span>';
                return;
            }
            
            let html = '<a href="/" class="hover:text-accent">Dashboard</a>';
            
            const routeNames = {
                'resources': 'Curriculum',
                'curriculum': 'Curriculum',
                'journal': 'Journal',
                'calendar': 'Calendar',
                'reports': 'Reports',
                'activity': 'Activity',
                'view': 'Week View',
                'edit': 'Edit'
            };
            
            let currentPath = '';
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                
                if (part === 'calendar' && parts.length > index + 1) {
                    const year = parts[index + 1];
                    const month = parts[index + 2];
                    if (month) {
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = monthNames[parseInt(month) - 1] || month;
                        html += ` <i class="fas fa-chevron-right text-xs"></i> <span>${monthName} ${year}</span>`;
                        return;
                    }
                }
                
                if (part === 'view' && parts.length > index + 1) {
                    const phaseIndex = parseInt(parts[index + 1]);
                    const week = parts[index + 2];
                    if (week) {
                        html += ` <i class="fas fa-chevron-right text-xs"></i> <span>Phase ${phaseIndex + 1} > Week ${week}</span>`;
                        return;
                    }
                }
                
                if (index > 0 && parts[index - 1] === 'calendar' && (part.match(/^\d+$/) || index === 1)) {
                    return;
                }
                if (index > 0 && parts[index - 1] === 'view' && part.match(/^\d+$/)) {
                    return;
                }
                
                const name = routeNames[part] || part.charAt(0).toUpperCase() + part.slice(1);
                
                if (index === parts.length - 1) {
                    html += ` <i class="fas fa-chevron-right text-xs"></i> <span>${name}</span>`;
                } else {
                    html += ` <i class="fas fa-chevron-right text-xs"></i> <a href="${currentPath}" class="hover:text-accent">${name}</a>`;
                }
            });
            
            breadcrumbs.innerHTML = html;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateThemeIcon();
            generateBreadcrumbs();
        });
    </script>
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Toast Notification Script -->
    <script>
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${iconMap[type] || iconMap.info}"></i>
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }
        
        function removeToast(toast) {
            if (!toast) return;
            toast.classList.add('removing');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }
    </script>
    </div> <!-- End main-content-wrapper -->
    </body>
</html>
